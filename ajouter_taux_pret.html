<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion des Taux de Prêt</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin: 5px; padding: 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .interval-group { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; }
    .interval-group input { width: 100px; }
    .remove-btn { background-color: crimson; color: white; border: none; padding: 3px 8px; cursor: pointer; }
  </style>
</head>
<body>

  <h1>Gestion des Taux de Prêt</h1>

  <div>
    <input type="text" id="type_pret" placeholder="Type de prêt" required>
    <input type="number" id="inf_mois" placeholder="Inf. à (mois)" required>
    <input type="number" step="0.01" id="inf_taux" placeholder="Taux %" required>
    <input type="number" id="sup_mois" placeholder="Sup. à (mois)" required>
    <input type="number" step="0.01" id="sup_taux" placeholder="Taux %" required>
  </div>

  <h3>Intervalles de Taux</h3>
  <div id="intervals_container">
    <div class="interval-group">
      <input type="number" placeholder="Min (mois)" class="min" required>
      <input type="number" placeholder="Max (mois)" class="max" required>
      <input type="number" step="0.01" placeholder="Taux (%)" class="taux" required>
    </div>
  </div>
  <button onclick="ajouterIntervalle()">+ Ajouter Intervalle</button>
  <button onclick="enregistrerTaux()">Enregistrer</button>

  <div id="liste-taux"></div>


  <script>
    const apiBase = "http://localhost/S4/ef_mvc/ws";
    function ajouterIntervalle() {
      const container = document.getElementById("intervals_container");
      const group = document.createElement("div");
      group.classList.add("interval-group");

      group.innerHTML = `
        <input type="number" placeholder="Min (mois)" class="min" required>
        <input type="number" placeholder="Max (mois)" class="max" required>
        <input type="number" step="0.01" placeholder="Taux (%)" class="taux" required>
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">×</button>
      `;
      container.appendChild(group);
    }
    function enregistrerTaux() {
    const typePret = document.getElementById("type_pret").value;
    const infMois = document.getElementById("inf_mois").value;
    const infTaux = document.getElementById("inf_taux").value;
    const supMois = document.getElementById("sup_mois").value;
    const supTaux = document.getElementById("sup_taux").value;

    const minInputs = document.querySelectorAll(".min");
    const maxInputs = document.querySelectorAll(".max");
    const tauxInputs = document.querySelectorAll(".taux");

    const formData = new FormData();
    formData.append("type_pret", typePret);
    formData.append("inf_mois", infMois);
    formData.append("inf_taux", infTaux);
    formData.append("sup_mois", supMois);
    formData.append("sup_taux", supTaux);

    for (let i = 0; i < minInputs.length; i++) {
      formData.append("min[]", minInputs[i].value);
      formData.append("max[]", maxInputs[i].value);
      formData.append("taux[]", tauxInputs[i].value);
    }

    fetch(apiBase + "/taux_pret/ajouter", {
      method: "POST",
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("Taux enregistrés avec succès !");
        resetForm();
      } else {
        alert("Erreur : " + data.message);
      }
    })
    .catch(err => {
      console.error("Erreur AJAX:", err);
    });
  }
    function resetForm() {
      document.getElementById("type_pret").value = "";
      document.getElementById("inf_mois").value = "";
      document.getElementById("inf_taux").value = "";
      document.getElementById("sup_mois").value = "";
      document.getElementById("sup_taux").value = "";
      document.getElementById("intervals_container").innerHTML = `
        <div class="interval-group">
          <input type="number" placeholder="Min (mois)" class="min" required>
          <input type="number" placeholder="Max (mois)" class="max" required>
          <input type="number" step="0.01" placeholder="Taux (%)" class="taux" required>
        </div>
      `;
    }
  
    function chargerTaux() {
  fetch(apiBase + "/taux_pret")
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("liste-taux");
      container.innerHTML = "";

      data.forEach(row => {
        const div = document.createElement("div");
        div.style.border = "1px solid #ccc";
        div.style.padding = "10px";
        div.style.margin = "10px 0";
        div.style.borderRadius = "6px";
        div.style.backgroundColor = "#f9f9f9";

        let html = `<h3>${row.type}</h3>`;
        html += `<p><strong>0 à ${row.inf_mois} mois</strong> : ${row.inf_taux} %</p>`;

        if (row.intervalles.length > 0) {
          html += `<p><strong>Intervalles :</strong><br>`;
          row.intervalles.forEach(interval => {
            html += `${interval}<br>`;
          });
          html += `</p>`;
        }

        html += `<p><strong>> ${row.sup_mois} mois</strong> : ${row.sup_taux} %</p>`;

        div.innerHTML = html;
        container.appendChild(div);
      });
    });
}

chargerTaux();

// Après insertion
function enregistrerTaux() {
  // ... formulaire ...
  fetch(apiBase + "/taux_pret/ajouter", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert("Taux enregistrés avec succès !");
      resetForm();
      chargerTaux(); // recharger les taux
    } else {
      alert("Erreur : " + data.message);
    }
  })
  .catch(err => {
    console.error("Erreur AJAX:", err);
  });
}

  </script>

</body>
</html>
